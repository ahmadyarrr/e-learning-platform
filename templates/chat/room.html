{%extends 'base/base.html' %}
{%load static%}
{% block title %}
  Chat room for "{{ course.title }}"
{% endblock %}
{%block head%}
  <link rel="stylesheet" href="{%static 'css/chat/chat_room.css'%}">
{%endblock%}
{% block body %}
  <div id="chat"></div>
  
  <div class="rightside">
        <div class="header">
               <div class="imgtext">
                <div class="userimg">
                    <img src="{{course.image.url}}" class="cover">
                </div>
                <h4>{{course.title}} <br> <span>tap here for group info</span></h4>
               </div>
                <ul class="nav_icons">
                    <li><img src="search.png" alt=""></li>
                    <li> <img src="dot.png" alt=""></li>
                </ul>
            </div>
            <!----Chat Box---->
            <div id="messages">
                <div class="message frnd">
                    <p>Hi <br> <span>5:41 pm</span></p>
                </div>  
                <div class="message mine">
                  <p>Lorem. <br> <span>6:17 pm</span></p>
                </div>

            </div>
            <!----Chat input---->
            <form id="chat-form">
              <div id="chat-input">
                <input name="message" id="chat-message-input" placeholder="Type a message" type="text" />
                <input  id="chat-message-submit" type="submit" value="Send" />
              </div>
            <form>
        </div>
<script>
  window.addEventListener("DOMContentLoaded", function(event){
                // getting course id
          const course_id = JSON.parse(document.getElementById('course-id').textContent);
        
          // getting username
          const request_user = JSON.parse(document.getElementById('request-user').textContent);

          console.log(course_id,request_user)

          // creating the room url for the specific course
          const url = 'ws://'+window.location.host+'/ws/chat/room/'+ course_id + '/';
          console.log(url);
          
          // creating the WebSocket
          let chatSoc = new WebSocket(url);
          console.log('connection successful!');

          // handling the server's messages; note that it is called everytime a message is sent here
          chatSoc.onmessage = function(e){

            // e.data refers to the data comming from server-side
            const data = JSON.parse(e.data);
            if (data.type =='chat_message'){
              
              // determining the date the message has been sent
              const date_options = {'hour':'numeric','minute':'numeric',hour12:true}
              const date_sent = new Date(data.time).toLocaleString(date_options)

              // setting author info
              const sender = data.sender;
              const isMe = sender == request_user;
              console.log(sender,request_user,isMe,"=====---")
              const name = isMe ? 'Me': sender;
              const source = isMe ? 'mine':'frnd'; // used for left-right direction styling

              // assigning the message box to a variable and adding content
              const mess = document.getElementById('messages')
              mess.innerHTML += `<div class="message ${source}">
                                <p>${data.message}. <br> <span>${date_sent}</span></p>
                                 </div>  `
              
            
              mess.scrollTop = mess.scrollHeight;
            }
             
          }
          chatSoc.onclose = function(){
            console.log('Chat was closed!')
          }
          // sending the message using the form, no by submission
          const form = document.getElementById('chat-form');
          console.log('got the form',form)
          form.addEventListener('submit', function(e){
            e.preventDefault();
            let message = e.target.message.value;
            chatSoc.send(JSON.stringify({
              'message':message,
            }))
            form.reset();

          })


  })

</script>
  {% comment %} submit part  {% endcomment %}
  
    
{% endblock %}
{% block include_js %}
  {{course.id|json_script:'course-id'}}
  {{time|json_script:'time-data'}}
  {{request.user.username|json_script:'request-user'}}
{% endblock %}

